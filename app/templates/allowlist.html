{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Allow Policy Toggles</h2>
  <p class="muted">
    These toggles define what is allowed in <strong>Whitelist Schedule Mode</strong>.
    If schedule mode is set to "Allow allowlist", only matching allowlist content can play.
  </p>
  <form id="allow-policy-form">
    <div class="policy-grid">
      {% for preset in allow_policy_presets %}
      <label class="policy-item">
        <input type="checkbox" data-policy-key="{{ preset.key }}" {% if allow_policy_flags.get(preset.key) %}checked{% endif %}>
        <span>
          <strong>{{ preset.label }}</strong><br>
          <span class="muted">{{ preset.description }}</span>
        </span>
      </label>
      {% endfor %}
    </div>
    <div class="inline-actions" style="margin-top:10px;">
      <button type="button" class="small-btn" onclick="setAllAllowPolicies(true)">Enable All</button>
      <button type="button" class="small-btn" onclick="setAllAllowPolicies(false)">Disable All</button>
      <button type="submit">Save Allow Policies</button>
    </div>
  </form>
  <p id="allow-policy-status" class="muted"></p>
</section>

<section class="card">
  <h2>Whitelist Prompt Preview</h2>
  <p class="muted">This prompt is used when the active schedule mode is "Allow allowlist".</p>
  <textarea rows="12" readonly>{{ effective_whitelist_prompt }}</textarea>
</section>

<section class="card">
  <h2>Recent Allowed Videos (Last 10)</h2>
  <table>
    <thead><tr><th>Time</th><th>Video</th><th>Source</th><th>Action</th></tr></thead>
    <tbody>
      {% for row in allowed_recent %}
      <tr>
        <td>{{ row.created_at }}</td>
        <td>
          {% if row.video_id %}
          <a class="small-link" href="https://www.youtube.com/watch?v={{ row.video_id }}" target="_blank" rel="noopener noreferrer">{{ row.title or row.video_id }}</a>
          {% else %}
          {{ row.title }}
          {% endif %}
        </td>
        <td>{{ row.source }}</td>
        <td>{{ row.action_taken }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card">
  <h2>Whitelist Sources</h2>
  <p class="muted">Use local and remote allowlist files to share approved video/channel collections.</p>
  <table>
    <tbody>
      <tr><th>Entries</th><td>{{ allowlist_summary.entries_count }}</td></tr>
      <tr><th>Videos</th><td>{{ allowlist_summary.video_count }}</td></tr>
      <tr><th>Channels</th><td>{{ allowlist_summary.channel_count }}</td></tr>
      <tr><th>Loaded at</th><td>{{ allowlist_summary.loaded_at or '-' }}</td></tr>
      <tr><th>Local file</th><td><code>{{ allowlist_summary.local_path }}</code></td></tr>
    </tbody>
  </table>

  <form id="sources-form">
    <label>Raw source URLs (one per line)
      <textarea name="urls" rows="5">{% for s in allowlist_sources %}{{ s }}
{% endfor %}</textarea>
    </label>
    <div class="inline-actions">
      <button type="submit">Save Sources</button>
      <button type="button" class="small-btn" onclick="reloadAllowlists()">Reload Sources</button>
    </div>
  </form>

  <form id="local-allowlist-form">
    <label>Local allowlist file
      <textarea name="content" rows="14">{{ local_allowlist_content }}</textarea>
    </label>
    <button type="submit">Save Local Allowlist</button>
  </form>
  <p id="allowlist-status" class="muted"></p>
</section>

<section class="card">
  <h2>Add Allow Rule</h2>
  <form id="wl-form">
    <label>Scope
      <select name="scope">
        <option value="video">video</option>
        <option value="channel">channel</option>
      </select>
    </label>
    <label>Video ID <input name="video_id"></label>
    <label>Channel ID <input name="channel_id"></label>
    <label>Label/Comment <input name="label" placeholder="Optional human title"></label>
    <label>Link <input name="url" placeholder="https://www.youtube.com/..."></label>
    <button type="submit">Add to Allowlist</button>
  </form>
</section>

<section class="card">
  <h2>Allowlist Rules (latest 200)</h2>
  <table>
    <thead><tr><th>ID</th><th>Scope</th><th>Value</th><th>Label</th><th>Link</th><th>Source</th><th>Created</th><th>Action</th></tr></thead>
    <tbody>
      {% for rule in rules %}
      <tr>
        <td>{{ rule.id }}</td>
        <td>{{ rule.scope }}</td>
        <td>{{ rule.value }}</td>
        <td>{{ rule.label }}</td>
        <td>
          {% if rule.url %}
            <a class="small-link" href="{{ rule.url }}" target="_blank" rel="noopener noreferrer">Open</a>
          {% endif %}
        </td>
        <td>{{ rule.source_list }}</td>
        <td>{{ rule.created_at }}</td>
        <td><button onclick="deleteRule({{ rule.id }})">Delete</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
function collectAllowPolicyFlags() {
  const out = {};
  document.querySelectorAll('#allow-policy-form input[type=checkbox][data-policy-key]').forEach((cb) => {
    out[cb.dataset.policyKey] = cb.checked;
  });
  return out;
}

function setAllAllowPolicies(value) {
  document.querySelectorAll('#allow-policy-form input[type=checkbox][data-policy-key]').forEach((cb) => {
    cb.checked = value;
  });
}

document.getElementById('allow-policy-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const status = document.getElementById('allow-policy-status');
  status.textContent = 'Saving allow policies...';
  status.style.color = '#5f6d6f';
  const payload = {flags: collectAllowPolicyFlags()};
  const r = await fetch('/api/allowlist/policies', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if (!r.ok) {
    status.textContent = 'Failed to save allow policies: ' + await r.text();
    status.style.color = '#8a3a1c';
    return;
  }
  status.textContent = 'Allow policies saved.';
  status.style.color = '#0e5f5f';
});

document.getElementById('wl-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const f = document.getElementById('wl-form');
  const fd = new FormData(f);
  const payload = {
    scope: fd.get('scope'),
    video_id: fd.get('video_id') || null,
    channel_id: fd.get('channel_id') || null,
    label: fd.get('label') || null,
    url: fd.get('url') || null,
  };
  const r = await fetch('/api/rules/whitelist', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  if (!r.ok) alert(await r.text());
  else location.reload();
});

async function deleteRule(id) {
  const r = await fetch('/api/rules/' + id, {method:'DELETE'});
  if (!r.ok) alert(await r.text());
  else location.reload();
}

async function saveSources() {
  const status = document.getElementById('allowlist-status');
  const fd = new FormData(document.getElementById('sources-form'));
  const urls = String(fd.get('urls') || '').split('\n').map(x => x.trim()).filter(Boolean);
  status.textContent = 'Saving sources...';
  status.style.color = '#5f6d6f';
  const r = await fetch('/api/allowlist/sources', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({urls}),
  });
  if (!r.ok) {
    status.textContent = await r.text();
    status.style.color = '#8a3a1c';
    return;
  }
  status.textContent = 'Sources saved and reloaded.';
  status.style.color = '#0e5f5f';
  location.reload();
}

async function reloadAllowlists() {
  const status = document.getElementById('allowlist-status');
  status.textContent = 'Reloading...';
  status.style.color = '#5f6d6f';
  const r = await fetch('/api/allowlist/reload', {method:'POST'});
  if (!r.ok) {
    status.textContent = await r.text();
    status.style.color = '#8a3a1c';
    return;
  }
  status.textContent = 'Reload complete.';
  status.style.color = '#0e5f5f';
  location.reload();
}

async function saveLocalAllowlist() {
  const status = document.getElementById('allowlist-status');
  const fd = new FormData(document.getElementById('local-allowlist-form'));
  status.textContent = 'Saving local allowlist...';
  status.style.color = '#5f6d6f';
  const r = await fetch('/api/allowlist/local', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({content: fd.get('content') || ''}),
  });
  if (!r.ok) {
    status.textContent = await r.text();
    status.style.color = '#8a3a1c';
    return;
  }
  status.textContent = 'Local allowlist saved and loaded.';
  status.style.color = '#0e5f5f';
}

document.getElementById('sources-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  await saveSources();
});

document.getElementById('local-allowlist-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  await saveLocalAllowlist();
});
</script>
{% endblock %}
